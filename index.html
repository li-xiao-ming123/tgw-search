<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>丰川极速文搜</title>
    
    <!-- PWA 相关 -->
    <link rel="manifest" href="/tgw-search/manifest.json">
    <meta name="theme-color" content="#4CAF50">
    
    <!-- 各种尺寸的图标 -->
    <link rel="icon" type="image/x-icon" href="/tgw-search/favicon.ico">
    <link rel="icon" type="image/png" sizes="16x16" href="/tgw-search/icon-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/tgw-search/icon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/tgw-search/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/tgw-search/icon-512.png">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <style>
        /* 基础变量设置 */
        :root {
            --primary-color: #4CAF50;
            --primary-hover: #45a049;
            --background-color: #f5f5f5;
            --card-background: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --hover-color: #f8f8f8;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --category-header: #f9f9f9;
            --grid-columns-mobile: 2;
            --grid-columns-tablet: 3;
            --grid-columns-desktop: 4;
            --grid-columns-large: 5;
            --item-min-width: 140px;
            --spacing-unit: 8px;
        }

        /* 基础样式 */
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: var(--background-color);
            color: var(--text-color);
        }

        /* 在现有样式中添加或更新以下内容 */
        :root {
            --grid-columns-mobile: 2;
            --grid-columns-tablet: 3;
            --grid-columns-desktop: 4;
            --grid-columns-large: 5;
            --item-min-width: 140px;
            --spacing-unit: 8px;
        }
        
        .link-grid {
            display: grid;
            gap: var(--spacing-unit);
            padding: var(--spacing-unit);
        }
        
        /* 移动端（小于768px） */
        @media (max-width: 767px) {
            body {
                padding: var(--spacing-unit);
            }
        
            .container {
                padding: var(--spacing-unit);
            }
        
            .link-grid {
                grid-template-columns: repeat(var(--grid-columns-mobile), 1fr);
            }
        
            .category-header {
                flex-direction: column;
                gap: var(--spacing-unit);
            }
        
            .header-actions {
                flex-wrap: wrap;
                gap: var(--spacing-unit);
            }
        
            .custom-site-item {
                padding: var(--spacing-unit);
            }
        
            .search-link {
                font-size: 14px;
            }
        
            .batch-open {
                width: 100%;
                margin-top: var(--spacing-unit);
            }
        }
        
        /* 平板（768px - 1023px） */
        @media (min-width: 768px) and (max-width: 1023px) {
            .link-grid {
                grid-template-columns: repeat(var(--grid-columns-tablet), 1fr);
            }
        }
        
        /* 桌面端（1024px - 1439px） */
        @media (min-width: 1024px) and (max-width: 1439px) {
            .link-grid {
                grid-template-columns: repeat(var(--grid-columns-desktop), 1fr);
            }
        }
        
        /* 大屏幕（1440px及以上） */
        @media (min-width: 1440px) {
            .link-grid {
                grid-template-columns: repeat(var(--grid-columns-large), 1fr);
            }
        }
        
        /* 触摸设备优化 */
        @media (hover: none) {
            .custom-site-item {
                padding: calc(var(--spacing-unit) * 1.5);
            }
        
            .site-checkbox {
                min-width: 24px;
                min-height: 24px;
            }
        
            .batch-open {
                padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
            }
        }
        
        /* 确保在任何设备上的最小点击区域 */
        .custom-site-item {
            min-height: 44px;
        }
        
        .search-link, .batch-open, .delete-btn {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* 优化加载性能 */
        .custom-site-item {
            will-change: transform;
            transform: translateZ(0);
        }
        
        /* 优化动画性能 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

    </style>

</head>
<body>
    <div class="container">
        <h1>丰川极速文搜</h1>
        <input type="text" id="searchInput" class="search-box" placeholder="请输入搜索关键词" autofocus>
        
        <div class="category">
            <div class="category-header">
                <div class="category-title">默认搜索</div>
                <div class="header-actions">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="site-checkbox" 
                               onclick="toggleAll(this, 'defaultLinks')" id="defaultAll">
                        <label for="defaultAll">全选</label>
                    </div>
                    <button class="batch-open" onclick="batchOpenSelected('defaultLinks')">打开选中</button>
                </div>
            </div>
            <div class="link-grid" id="defaultLinks"></div>
        </div>
        
        <div class="category">
            <div class="category-header">
                <div class="category-title">综合搜索</div>
                <div class="header-actions">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="site-checkbox" 
                               onclick="toggleAll(this, 'generalLinks')" id="generalAll">
                        <label for="generalAll">全选</label>
                    </div>
                    <button class="batch-open" onclick="batchOpenSelected('generalLinks')">打开选中</button>
                </div>
            </div>
            <div class="link-grid" id="generalLinks"></div>
        </div>
        
        <div class="category">
            <div class="category-header">
                <div class="category-title">学术搜索</div>
                <div class="header-actions">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="site-checkbox" 
                               onclick="toggleAll(this, 'researchLinks')" id="researchAll">
                        <label for="researchAll">全选</label>
                    </div>
                    <button class="batch-open" onclick="batchOpenSelected('researchLinks')">打开选中</button>
                </div>
            </div>
            <div class="link-grid" id="researchLinks"></div>
        </div>
        
        <div class="category">
            <div class="category-header">
                <div class="category-title">外文搜索</div>
                <div class="header-actions">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="site-checkbox" 
                               onclick="toggleAll(this, 'englishLinks')" id="englishAll">
                        <label for="englishAll">全选</label>
                    </div>
                    <button class="batch-open" onclick="batchOpenSelected('englishLinks')">打开选中</button>
                </div>
            </div>
            <div class="link-grid" id="englishLinks"></div>
        </div>
        
        <div class="category">
            <div class="category-header">
                <div class="category-title">繁体/古籍</div>
                <div class="header-actions">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="site-checkbox" 
                               onclick="toggleAll(this, 'traditionalLinks')" id="traditionalAll">
                        <label for="traditionalAll">全选</label>
                    </div>
                    <button class="batch-open" onclick="batchOpenSelected('traditionalLinks')">打开选中</button>
                </div>
            </div>
            <div class="link-grid" id="traditionalLinks"></div>
        </div>

        <div class="category">
            <div class="category-header">
                <div class="category-title">自定义搜索源</div>
                <div class="header-actions">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" class="site-checkbox" 
                               onclick="toggleAll(this, 'customLinks')" id="customAll">
                        <label for="customAll">全选</label>
                    </div>
                    <button class="batch-open" onclick="batchOpenSelected('customLinks')">打开选中</button>
                    <button class="batch-open" onclick="addCustomSite()">添加网站</button>
                </div>
            </div>
            <div class="link-grid" id="customLinks"></div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <div id="customSiteModal" class="modal">
        <div class="modal-content">
            <h3>添加自定义搜索源</h3>
            <input type="text" id="siteName" placeholder="网站名称" class="search-box">
            <input type="text" id="siteUrl" placeholder="搜索URL（使用 {q} 表示搜索词）" class="search-box">
            <div class="modal-buttons">
                <button onclick="saveCustomSite()" class="batch-open">保存</button>
                <button onclick="closeModal()" class="batch-open" style="background: #666;">取消</button>
            </div>
        </div>
    </div>
    <script>
        const defaultSites = [
            {name: 'Z-Library', url: 'https://z-library.sk/s/{q}'},
            {name: 'LibGen', url: 'http://libgen.li/index.php?req={q}'},
            {name: 'Google', url: 'https://www.google.com/search?q={q}'},
            {name: '百度', url: 'https://www.baidu.com/s?wd={q}'},
            {name: 'Bing', url: 'https://cn.bing.com/search?q={q}'},
            {name: '词典论坛', url: 'https://forum.freemdict.com/search?q={q}'},
            {name: 'Panso', url: 'https://panso.pro/search?q={q}'},
            {name: '阿里小站', url: 'https://pan666.net/?q={q}'},
            {name: '读秀', url: 'https://book.duxiu.com/search?sw={q}'},
            {name: '鸠摩搜书', url: 'https://www.jiumodiary.com'},
            {name: "Anna's Archive", url: 'https://annas-archive.org/search?q={q}'},
            {name: 'B站', url: 'https://search.bilibili.com/all?keyword={q}'},
            {name: '知乎', url: 'https://www.zhihu.com/search?q={q}'}
        ];

        const generalSites = [
            {name: 'Gutenberg', url: 'https://www.gutenberg.org/ebooks/search/?query={q}'},
            {name: 'Wislib', url: 'https://www.wislib.com/search?key={q}'},
            {name: 'Hallowlib', url: 'https://bk.hallowlib.org'},
            {name: '小白盘', url: 'https://www.xiaobaipan.com/list-{q}AD.html'},
            {name: '虫部落', url: 'https://www.google.com/search?sitesearch=chongbuluo.com&query={q}'},
            {name: 'tstrs', url: 'https://book.tstrs.me/search'},
            {name: 'Proletarian', url: 'https://library.proletarian.me/searchResult.php?query={q}'},
            {name: 'LOC', url: 'https://www.loc.gov/search/?in=partof%3Aworld+digital+library&q={q}'}
        ];

        const researchSites = [
            {name: 'Google Scholar', url: 'https://scholar.google.com/scholar?q={q}'},
            {name: 'arXiv', url: 'https://arxiv.org/search/?query={q}'},
            {name: '百度学术', url: 'https://xueshu.baidu.com/s?wd={q}'},
            {name: 'CNKI', url: 'https://www.cnki.net/search.aspx?q={q}'},
            {name: 'Sci-Hub', url: 'https://sci-hub.box'},
            {name: '公众学术', url: 'https://pubscholar.cn'},
            {name: '台湾电子书', url: 'https://taebc.ebook.hyread.com.tw/searchList.jsp?search_field=FullText&search_input={q}'},
            {name: 'NAP', url: 'https://nap.nationalacademies.org'},
            {name: 'NCPSSD', url: 'https://www.ncpssd.org'},
            {name: 'UCDRS', url: 'http://www.ucdrs.cn'},
            {name: 'Marxists', url: 'https://www.marxists.org/chinese/index.html'},
            {name: 'NAP.edu', url: 'https://www.nap.edu'},
            {name: 'MIT OCW', url: 'https://ocw.mit.edu/search/?q={q}'}
        ];

        const englishSites = [
            {name: 'PDF Drive', url: 'https://www.pdfdrive.com/search?q={q}'},
            {name: 'Springer', url: 'https://link.springer.com/search?query={q}'},
            {name: 'iHeart', url: 'https://iheartintelligence.com/free-books-100-legal-sites-download-literature'},
            {name: 'BL Blogs', url: 'https://www.bl.uk/research/blogs'},
            {name: 'PALMM', url: 'https://palmm.digital.flvc.org'},
            {name: 'OAPEN', url: 'https://library.oapen.org/discover?query={q}'},
            {name: 'MagazineLib', url: 'https://magazinelib.com/?s={q}'},
            {name: 'ICPSR', url: 'https://www.icpsr.umich.edu/web/ICPSR/search/studies?q={q}'},
            {name: 'FreePDFMag', url: 'https://www.freepdfmagazine.com'}
        ];

        const traditionalSites = [
            {name: '古籍馆', url: 'https://www.gujiguan.com/#/search?keyword={q}'},
            {name: '书格', url: 'https://www.shuge.org/?s={q}'},
            {name: '国学导航', url: 'http://guoxue.er07.com'},
            {name: '台大图书馆', url: 'https://ntu.primo.exlibrisgroup.com/discovery/search?query=any,contains,{q}'},
            {name: '好读', url: 'http://haodoo.net'},
            {name: '四库全书', url: 'http://skqs.lib.ntnu.edu.tw/dragon'},
            {name: '家谱库', url: 'https://jiapu.library.sh.cn/#/genealogyFullSearch?keywords={q}'}
        ];

        let customSites = JSON.parse(localStorage.getItem('customSites') || '[]');

        function showNotification(message, duration = 3000) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        function createLinks(sites, containerId, isCustom = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // 清空现有内容
            sites.forEach((site, index) => {
                const linkContainer = document.createElement('div');
                linkContainer.className = 'custom-site-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'site-checkbox';
                checkbox.dataset.index = index;
                linkContainer.appendChild(checkbox);
                
                const link = document.createElement('a');
                link.className = 'search-link';
                link.textContent = site.name;
                link.href = '#';
                link.onclick = (e) => {
                    e.preventDefault();
                    const query = document.getElementById('searchInput').value;
                    if (query) {
                        window.open(site.url.replace('{q}', encodeURIComponent(query)));
                    } else {
                        showNotification('请输入搜索关键词');
                    }
                };
                
                linkContainer.appendChild(link);
                
                if (isCustom) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-btn';
                    deleteBtn.textContent = '删除';
                    deleteBtn.onclick = () => deleteCustomSite(index);
                    linkContainer.appendChild(deleteBtn);
                }
                
                container.appendChild(linkContainer);
            });
        }

        function toggleAll(checkbox, containerId) {
            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('.site-checkbox');
            checkboxes.forEach(box => box.checked = checkbox.checked);
        }

        function addCustomSite() {
            document.getElementById('customSiteModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('customSiteModal').style.display = 'none';
        }

        function saveCustomSite() {
            const name = document.getElementById('siteName').value.trim();
            const url = document.getElementById('siteUrl').value.trim();
            
            if (!name || !url) {
                showNotification('请填写完整信息');
                return;
            }
            
            customSites.push({name, url});
            localStorage.setItem('customSites', JSON.stringify(customSites));
            
            // 清空输入框
            document.getElementById('siteName').value = '';
            document.getElementById('siteUrl').value = '';
            
            // 刷新自定义链接列表
            createLinks(customSites, 'customLinks', true);
            
            closeModal();
            showNotification('添加成功');
        }

        function deleteCustomSite(index) {
            customSites.splice(index, 1);
            localStorage.setItem('customSites', JSON.stringify(customSites));
            createLinks(customSites, 'customLinks', true);
            showNotification('删除成功');
        }

        function batchOpenSelected(containerId) {
            const query = document.getElementById('searchInput').value;
            if (!query) {
                showNotification('请输入搜索关键词');
                return;
            }

            let sites;
            switch(containerId) {
                case 'defaultLinks': sites = defaultSites; break;
                case 'generalLinks': sites = generalSites; break;
                case 'researchLinks': sites = researchSites; break;
                case 'englishLinks': sites = englishSites; break;
                case 'traditionalLinks': sites = traditionalSites; break;
                case 'customLinks': sites = customSites; break;
                default: return;
            }

            const container = document.getElementById(containerId);
            const checkboxes = container.querySelectorAll('.site-checkbox');
            let selectedCount = 0;

            checkboxes.forEach((checkbox, index) => {
                if (checkbox.checked) {
                    selectedCount++;
                    const site = sites[index];
                    if (site.url.includes('jiumodiary.com') || 
                        site.url.includes('sci-hub.box') || 
                        site.url.includes('guoxue.er07.com') ||
                        site.url.includes('haodoo.net') ||
                        site.url.includes('pubscholar.cn') ||
                        !site.url.includes('{q}')) {
                        window.open(site.url);
                    } else {
                        const url = site.url.replace('{q}', encodeURIComponent(query));
                        setTimeout(() => {
                            window.open(url);
                        }, selectedCount * 300);
                    }
                }
            });

            if (selectedCount === 0) {
                showNotification('请至少选择一个网站');
            } else {
                showNotification(`正在打开${selectedCount}个搜索结果，请允许弹出窗口`);
            }
        }

        // 初始化所有链接
        createLinks(defaultSites, 'defaultLinks');
        createLinks(generalSites, 'generalLinks');
        createLinks(researchSites, 'researchLinks');
        createLinks(englishSites, 'englishLinks');
        createLinks(traditionalSites, 'traditionalLinks');
        createLinks(customSites, 'customLinks', true);

        // 添加回车搜索功能
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                batchOpenSelected('defaultLinks');
            }
        });
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/book-search/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful');
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
    </script>
</body>
</html>
